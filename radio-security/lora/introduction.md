# LoRa技术

## LoRa简介

无线技术可组成局域网，例如熟悉的WiFi，蓝牙、Zigbee等，也可组成广域网的无线技术主要有4G/5g等。它们优缺点也很明显，功耗高或传输距离短，当采用**低功耗广域网（Low Power Wide Area Network, LPWAN）**技术之后，最大程度在低能耗下进行长距离的通讯。

LoRa 为 Long Range 的缩写，是LPWAN通信技术之一，是美国Semtech专有的一种基于扩频技术的超远距离无线传输技术。这一技术为用户提供一种简单的能实现远距离、低功耗无线通信手段。目前，LoRa 主要在全球免费频段运行，不需申请许可的次GHz射频频段，使用1 GHz以下的频带提供低功率和远程无线通信，包括433 MHz、868 MHz、915 MHz及923 MHz。

## LoRa网络构成

LoRa网络主要由终端（可内置LoRa模块）、网关（或称基站）、Server和云四部分组成。应用数据可双向传输。LoRa使用星型结构来实现长距离连接稳定性并确保节点电池寿命。

## LoRaWAN协议

LoRaWAN是LoRa联盟推出的一个基于开源MAC层协议的低功耗广域网通信协议。主要为电池供电的无线设备提供局域、全国或全球的网络通信协议。

LoRaWAN为LPWAN网络定义了通信协议和系统架构，LoRa物理层负责长距离通信。通信协议和网络体系结构对节点电池寿命，网络功能，服务质量，安全性和应用程序多样性具有重大影响。

## LoRaWAN网络拓扑

LoRaWAN网络架构是一个典型的星形拓扑结构，在这个网络架构中，LoRa网关是一个透明传输的中继，连接终端设备和后端中央服务器。网关与服务器间通过标准IP连接，终端设备采用单跳与一个或多个网关通信。所有的节点与网关间均是双向通信，同时也支持云端升级等操作以减少云端通讯时间。通过调整扩展因子，编码率和带宽，它支持多数据速率。



## LoRa和LoRaWAN

LoRaWAN是在LoRa物理层传输技术基础之上的以MAC层为主的一套协议标准。LoRa是基于CSS(ChirpSpread Spectrum)的物理层，LoRaWAN是基于LoRa的数据链路层，它在网关和终端设备之间提供星形拓扑网络。



## LoRa调制解调技术

LoRa 调制解调技术（ 下面简称 LoRa） 采用专有的调制和解调程序， 将扩频调制与循环纠错编码技术结合起来， 与传统的调制技术（FSK 或 OOK） 相比， 这种技术扩大了无线通讯链路的覆盖范围， 提高了链路的鲁棒性。



**扩频因子：**

LoRa 扩采用多个信息码片来代表有效负载信息的每个位。 扩频信息的发送速度称为符号速率（Rs） ，而码片速率与标称符号速率之间的比值即为扩频因子， 其表示每个信息位发送的符号数量。 负信噪比条件下信号也能正常接收， 提高了的灵敏度、 链路预算及覆盖范围。 但是不同扩频因子之间为正交关系， 因此 发送端和接收端的扩频因子必须一致。

| 扩频因子（RegModulationCfg） | 码片/符号 | LoRa解调器信噪比 |
| ---------------------------- | --------- | ---------------- |
| 6                            | 64        | -5dB             |
| 7                            | 128       | -7.5dB           |
| 8                            | 256       | -10dB            |
| 9                            | 512       | -12.5dB          |
| 10                           | 1024      | -15dB            |
| 11                           | 2048      | -17.5dB          |
| 12                           | 4096      | -20dB            |

由上表可以看出当扩频因子为 12 时在-20dB 还能收到数据包， 说明扩频因子越大灵敏度越高， 发送速度越慢。  



**编码率：**

LoRa 采用循环纠错编码进行前向错误检测与纠错， 但会产生传输开销。 每次传输产生的数据开销如下：  

| 编码率（RegTxCfg1) | 循环编码率 | 开销比率 |
| ------------------ | ---------- | -------- |
| 1                  | 4/5        | 1.25     |
| 2                  | 4/6        | 1.5      |
| 3                  | 4/7        | 1.75     |
| 4                  | 4/8        | 2        |

编码率越大前向纠错越强， 链路抗干扰性越强， 但是传输开销将会加大， 进而加大传输时间。



**信号带宽：**

由信号频谱图可以观察到一个信号所包含的频率成分。 把一个信号所包含谐波的最高频率与最低频率之差， 即该信号所拥有的频率范围， 定义为该信号的带宽。 信号的频率变化范围越大， 信号的带宽就越宽。  

| 带宽（kHz） | 扩频因子 | 编码率 | 标称比特率（bps） |
| ----------- | -------- | ------ | ----------------- |
| 7.8         | 12       | 4/5    | 18                |
| 10.4        | 12       | 4/5    | 24                |
| 15.6        | 12       | 4/5    | 37                |
| 20.8        | 12       | 4/5    | 49                |
| 31.2        | 12       | 4/5    | 73                |
| 41.7        | 12       | 4/5    | 98                |
| 62.5        | 12       | 4/5    | 146               |
| 125         | 12       | 4/5    | 293               |
| 250         | 12       | 4/5    | 586               |
| 500         | 12       | 4/5    | 1172              |

表可以看出增加信号带宽， 发送标称比特率越大， 说明增加信号带宽可以有效提高数据速率以缩短传输时间， 但会有弊端将会降低接收灵敏度， 缩短传输距离。  

## LoRa物理层帧结构

**LoRa Packet 格式：**

![image-20210108125136170](https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20210108125136170.png)

**preamble 前导码**

用于数据流同步。Preamble长度为8个Symbol。

**Header 报头**

可设置报头类型：显示报头、隐式报头

根 据 所 选 择 的 操 作 模 式 ， 可 以 选 用 两 种 报 头 。 在 RegModemConfig1 寄 存 器 上 ， 通 过 设 定ImplicitHeaderModeOn 位选择报头类型。

* **显式报头模式**：显式报头模式是默认的操作模式。 在这种模式下， 报头包含有效负载的相关信息， 包括：
  1. 以字节数表示的有效负载长度；
  2. 前向纠错码率；
  3. 是否打开可选的 16 位负载 CRC。
     报头按照最大纠错码（4/8） 发送。 另外， 报头还包含自己的 CRC， 使接收机可以丢弃无效的报头。

* **隐式报头模式**：

  在特定情况下， 如果有效负载长度、 编码率及 CRC 为固定或已知， 则比较有效的做法是通过调用隐式报头模式来缩短发送时间。 这种情况下， 需要手动设置无线链路两端的有效负载长度、 错误编码率及 CRC。注意： 如果将扩频因子 SF 设定为 6， 则只能使用隐式报头模式，   

  ​                                                                             

​           